db:
  image: postgres
  ports:
    - "5432"
redis:
  image: redis
  ports:
    - "6379"
web:
  build: .
  command: >
    /bin/bash -c '
    sleep 5;
    python manage.py migrate;
    python manage.py runserver 0.0.0.0:$PORT'
  volumes:
    - .:/src
    - /tmp
  environment:
    DEBUG: True
    LORE_LOG_LEVEL: DEBUG
    DJANGO_LOG_LEVEL: INFO
    PORT: 8070
    DATABASE_URL: postgres://postgres@db:5432/postgres
    ALLOWED_HOSTS:
    LORE_USE_CAS:
    LORE_ADMIN_EMAIL:
    LORE_CAS_URL:
    CELERY_ALWAYS_EAGER: False
    BROKER_URL: redis://redis:6379/4
    HAYSTACK_URL: elastic:9200
  ports:
    - "8070:8070"
  links:
    - db
    - redis
    - elastic
celery:
  build: .
  command: >
    /bin/bash -c '
    sleep 5;
    celery -A lore worker -l debug'
  volumes_from:
    - web
  environment:
    DEBUG: True
    LORE_LOG_LEVEL: DEBUG
    DJANGO_LOG_LEVEL: INFO
    DATABASE_URL: postgres://postgres@db:5432/postgres
    BROKER_URL: redis://redis:6379/4
    CELERY_RESULT_BACKEND: redis://redis:6379/4
    HAYSTACK_URL: elastic:9200
  links:
    - db
    - elastic
    - redis
elastic:
  image: elasticsearch
  ports:
    - "9200"
